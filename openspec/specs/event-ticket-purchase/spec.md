# event-ticket-purchase Specification

## Purpose
TBD - created by archiving change add-miniprogram-payment-bridge. Update Purpose after archive.
## Requirements
### Requirement: Event ticket order response includes channelized payment payload
The system SHALL return `channel` and `payPayload` in event ticket order creation responses so the client can launch the correct WeChat payment path.

#### Scenario: Mini Program bridge channel is returned for supported shell
- **WHEN** an authenticated user creates a paid event ticket order from Mini Program WebView and bridge capability is available
- **THEN** the order response includes `channel = MINIPROGRAM_BRIDGE`
- **AND** `payPayload` includes request-payment fields required by shell `wx.requestPayment`

### Requirement: Mini Program bridge availability is mandatory in Mini Program context
The system SHALL reject payment start in Mini Program context when bridge capability is unavailable or below the minimum supported version.

#### Scenario: Bridge capability is missing in Mini Program context
- **WHEN** a Mini Program WebView user creates or resumes a paid order without bridge capability support
- **THEN** the API returns `MINI_PROGRAM_BRIDGE_REQUIRED`
- **AND** the client shows an upgrade prompt
- **AND** the client does not downgrade to JSAPI or Native QR flow

### Requirement: Event ticket flow uses shared WeChat payment preparation capability
The system SHALL use the shared WeChat payment preparation capability for event ticket paid orders instead of route-specific channel shaping.

#### Scenario: Event ticket prepare delegates to shared payment orchestration
- **WHEN** a paid event ticket order is created
- **THEN** channel selection and payload are generated by shared WeChat payment orchestration logic
- **AND** event order APIs return the selected channel result

### Requirement: Bridge callback does not bypass order settlement truth
The system SHALL continue using webhook and explicit status query as the settlement source of truth after Mini Program bridge payment invocation.

#### Scenario: Bridge invocation succeeds but final status is pending
- **WHEN** bridge `requestPayment` reports success but webhook has not updated order status yet
- **THEN** the client keeps polling or manual query behavior
- **AND** order status transitions only when backend settlement logic confirms payment

