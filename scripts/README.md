# 数据库管理脚本

## 删除测试用户脚本

这个脚本可以帮助你安全地删除测试数据库中的所有用户，除了指定的保护用户。

### 功能特性

- 🔒 **安全删除**: 保护指定用户ID不被删除
- 📊 **预览模式**: 可以先查看所有用户再决定是否删除
- 🛡️ **生产环境保护**: 自动检测生产环境并拒绝执行
- 🔄 **事务处理**: 使用数据库事务确保数据一致性
- 💾 **级联删除**: 自动清理用户相关的所有数据
- ⚡ **强制删除**: 当常规删除遇到外键约束时使用

### 使用方法

#### 1. 查看当前用户
```bash
bun run db:show-users
# 或者
tsx scripts/delete-test-users-safe.ts show
```

#### 2. 删除测试用户（推荐首先尝试）
```bash
bun run db:delete-test-users
# 或者
tsx scripts/delete-test-users-safe.ts delete
```

#### 3. 强制删除测试用户（当遇到外键约束时）
```bash
bun run db:delete-test-users-force
# 或者
tsx scripts/delete-test-users-final.ts delete
```

### 保护用户

默认情况下，以下用户ID会被保护，不会被删除：
- `7777`
- `8888`

你可以在脚本中修改 `KEEP_USER_IDS` 数组来调整保护的用户列表。

### 删除的数据

脚本会删除用户及其相关的所有数据，包括：
- 用户基本信息
- 会话和认证数据
- 项目、评论、点赞等用户生成内容
- 活动注册和反馈
- 通知和邮件偏好
- 组织成员关系
- 等等...

### 安全机制

1. **生产环境保护**: 如果检测到 `NODE_ENV=production`，脚本会拒绝执行
2. **数据预览**: 删除前会显示将要删除的用户列表
3. **事务保护**: 所有删除操作都在一个数据库事务中执行
4. **错误处理**: 如果删除过程中出现错误，会回滚所有操作

### 注意事项

⚠️ **重要提醒**:
- 运行脚本前请确保已备份数据库
- 此操作不可逆，请谨慎执行
- 建议先运行 `show` 命令确认要删除的用户
- 确保当前环境确实是测试环境

### 自定义配置

如果需要修改保护的用户列表，编辑 `scripts/delete-test-users-safe.ts` 文件中的 `KEEP_USER_IDS` 数组：

```typescript
const KEEP_USER_IDS = ['7777', '8888', 'your-user-id']
```

### 故障排除

如果遇到外键约束错误，可能需要手动清理某些特殊表的数据，或者联系数据库管理员。